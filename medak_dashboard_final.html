<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medak District — Live Officers Performance Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{ --bg:#e8f8ff; --card: rgba(255,255,255,0.7); --accent:#0ea5e9; --muted:#375a70; --glass: rgba(255,255,255,0.6); }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:linear-gradient(135deg,#e8f8ff,#f7feff);color:var(--muted)}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.7));backdrop-filter:blur(6px);padding:12px 18px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap;z-index:20}
    header h1{margin:0;font-size:18px;color:#083047}
    header .small{font-size:12px;color:#2b556a}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=text], input[type=date], select{padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);min-width:180px;background:white}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:var(--card);cursor:pointer;font-weight:600}
    .container{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border-radius:14px;padding:12px;border:1px solid rgba(0,0,0,0.04)}
    .card h3{margin:0 0 8px 0;color:#083047;font-size:14px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:8px}
    .kpi{background:white;border-radius:10px;padding:10px;text-align:center;border:1px solid rgba(0,0,0,0.04)}
    .kpi .label{font-size:12px;color:#5d7b88}
    .kpi .value{font-size:18px;font-weight:800;color:#083047}
    #map{height:520px;border-radius:10px}
    @media(min-width:980px){.half{grid-column:span 6}.third{grid-column:span 4}.two{grid-column:span 2}.eight{grid-column:span 8}.ten{grid-column:span 10}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);font-size:13px;color:var(--muted)}
    th{background:linear-gradient(180deg,#ffffff,#f2fbff);position:sticky;top:0}
    .footer{font-size:13px;color:#256e8c;margin-top:8px}
    .hint{font-size:12px;color:#2b556a}
    .small-note{font-size:12px;color:#4b6b7b}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Medak District — Live Officers Performance Dashboard</h1>
      <div class="small">Automated from Google Sheets • Map: Mandal/Panchayat GeoJSON • Filters & Export</div>
    </div>
    <div class="controls">
      <input id="sheetId" type="text" placeholder="Google Sheet ID (paste here)">
      <input id="apiKey" type="text" placeholder="Google API Key">
      <input id="sheetRange" type="text" placeholder="Range (eg. 'Form Responses 1!A:Z')" value="Form Responses 1!A:Z">
      <input id="geoUrl" type="text" placeholder="GeoJSON URL (Mandal/Panchayat) (optional)">
      <button id="saveCfg" class="btn">Save</button>
      <button id="loadBtn" class="btn">Load Data</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card" style="grid-column:span 12">
        <div class="kpis">
          <div class="kpi"><div class="label">Total Tours</div><div id="kTotal" class="value">-</div></div>
          <div class="kpi"><div class="label">Unique Officers</div><div id="kOff" class="value">-</div></div>
          <div class="kpi"><div class="label">Avg Duration (hrs)</div><div id="kDur" class="value">-</div></div>
          <div class="kpi"><div class="label">With Attachments</div><div id="kAttach" class="value">-</div></div>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <div class="hint">Filters:</div>
          <input id="dateFrom" type="date">
          <input id="dateTo" type="date">
          <select id="officerSel"><option value="">All Officers</option></select>
          <select id="deptSel"><option value="">All Departments</option></select>
          <select id="mandalSel"><option value="">All Mandals</option></select>
          <select id="panchSel"><option value="">All Panchayats</option></select>
          <select id="purposeSel"><option value="">All Purposes</option></select>
          <select id="followSel"><option value="">All Follow-up</option><option>Completed</option><option>Action Required/Pending</option><option>Not Specified</option><option>Other</option></select>
          <select id="attachSel"><option value="">Attachments?</option><option value="yes">Has Attachment</option><option value="no">No Attachment</option></select>
          <button id="applyBtn" class="btn">Apply</button>
          <button id="resetBtn" class="btn">Reset</button>
          <button id="exportBtn" class="btn">Export CSV</button>
        </div>
      </div>

      <div class="card eight"><h3>Medak — Mandal / Panchayat Map</h3>
        <div id="map"></div>
        <div class="small-note">Hover a polygon to see name and tour count. Click features to see detailed list.</div>
      </div>

      <div class="card four"><h3>Top Insights</h3>
        <div id="insights" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
        <div class="footer">Suggestions: use GeoJSON with <b>NAME</b> or <b>mandal</b> or <b>NAME_3</b> properties; Panchayat GeoJSON with <b>Panchayat</b> or <b>name</b>.</div>
      </div>

      <div class="card half"><h3>Tours per Officer</h3><div id="chartOfficer" style="height:320px"></div></div>
      <div class="card half"><h3>Dept Participation</h3><div id="chartDept" style="height:320px"></div></div>

      <div class="card third"><h3>Mandal Coverage</h3><div id="chartMandal" style="height:300px"></div></div>
      <div class="card third"><h3>Purpose of Visits</h3><div id="chartPurpose" style="height:300px"></div></div>
      <div class="card third"><h3>Follow-up Status</h3><div id="chartFollow" style="height:300px"></div></div>

      <div class="card half"><h3>Duration Distribution (hrs)</h3><div id="chartDur" style="height:320px"></div></div>
      <div class="card half"><h3>Tours Over Time</h3><div id="chartTime" style="height:320px"></div></div>

      <div class="card" style="grid-column:span 12"><h3>Recent Tours (latest 50)</h3>
        <div style="max-height:320px;overflow:auto"><table id="recentTable"><thead><tr><th>Date</th><th>Officer</th><th>Dept</th><th>Mandal</th><th>Panchayat</th><th>Purpose</th><th>Dur(h)</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>
  </div>

<script>
/* Utilities and helper functions (date parsing, grouping, etc.) */
function sanitize(s){ return s==null? '' : String(s).trim(); }
function hasAttachment(v){ const s=sanitize(v); return !!s && /https?:\\/\\//i.test(s); }
function parseDateLike(input){
  if(!input) return null;
  let s = String(input).trim();
  s = s.replace(/(\\d{1,2})\\.(\\d{2})(?!\\d)/, '$1:$2'); // 10.00 -> 10:00
  const iso = new Date(s);
  if(!isNaN(iso)) return iso;
  const m = s.match(/(\\d{1,2})[-/](\\d{1,2})[-/](\\d{2,4})(?:\\s+(\\d{1,2}):(\\d{2}))?/);
  if(!m) return new Date(s);
  let [_, dd, mm, yy, HH, MM] = m;
  dd=+dd; mm=+mm-1; yy= yy.length===2? +('20'+yy) : +yy;
  HH = HH? +HH : 0; MM = MM? +MM : 0;
  return new Date(yy, mm, dd, HH, MM, 0, 0);
}
function hoursBetween(a,b){ if(!(a instanceof Date) || isNaN(a) || !(b instanceof Date) || isNaN(b)) return null; return (b-a)/(1000*60*60); }
function toDateKey(d){ if(!(d instanceof Date) || isNaN(d)) return 'Invalid'; const y=d.getFullYear(); const m=(''+(d.getMonth()+1)).padStart(2,'0'); const day=(''+d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function groupCount(arr, keyFn){ const m=new Map(); for(const it of arr){ const k=keyFn(it); m.set(k,(m.get(k)||0)+1);} return m; }
function mean(nums){ const v=nums.filter(n=>Number.isFinite(n)); return v.length? v.reduce((a,b)=>a+b,0)/v.length : null; }
function topN(map, n=20){ return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n); }
function uniqueSorted(arr){ return Array.from(new Set(arr.map(sanitize))).filter(Boolean).sort(); }
function downloadFile(filename, content){ const a=document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(content); a.download = filename; a.click(); }

/* Config persistence */
const cfgKeys=['sheetId','apiKey','sheetRange','geoUrl'];
function loadCfg(){ const o={}; for(const k of cfgKeys) o[k]=localStorage.getItem('medak_'+k) || ''; return o; }
function saveCfg(obj){ for(const k of cfgKeys){ if(obj[k]!=null) localStorage.setItem('medak_'+k, obj[k]); } }

/* Google Sheets fetch */
async function fetchSheet(sheetId, apiKey, range){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Google Sheets API error: '+ res.status + ' ' + res.statusText);
  const json = await res.json();
  const rows = json.values || [];
  if(rows.length===0) return [];
  const headers = rows[0].map(h => sanitize(h));
  const out = [];
  for(let i=1;i<rows.length;i++){
    const row = rows[i];
    const obj = {};
    headers.forEach((h, idx) => obj[h] = row[idx]===undefined? '' : row[idx]);
    out.push(obj);
  }
  return out;
}

/* GeoJSON fetch */
async function fetchGeoJSON(url){
  if(!url) return null;
  const res = await fetch(url);
  if(!res.ok) throw new Error('GeoJSON fetch error: '+res.status);
  return await res.json();
}

/* State */
let RAW = []; let GEO = null; let MAP = null; let GEO_LAYER = null;

/* UI wiring */
const el = id => document.getElementById(id);
const cfg0 = loadCfg();
el('sheetId').value = cfg0.sheetId || '';
el('apiKey').value = cfg0.apiKey || '';
el('sheetRange').value = cfg0.sheetRange || 'Form Responses 1!A:Z';
el('geoUrl').value = cfg0.geoUrl || '';

el('saveCfg').onclick = () => { saveCfg({sheetId:el('sheetId').value, apiKey:el('apiKey').value, sheetRange:el('sheetRange').value, geoUrl:el('geoUrl').value}); alert('Saved configuration to localStorage'); }
el('loadBtn').onclick = async () => { await loadAll(); };
el('applyBtn').onclick = () => { const f = applyFilters(); renderAll(f); if(GEO) renderMap(f); };
el('resetBtn').onclick = () => { resetFilters(); renderAll(RAW); if(GEO) renderMap(RAW); };
el('exportBtn').onclick = () => { exportCSV(applyFilters()); };

function resetFilters(){ for(const id of ['dateFrom','dateTo','officerSel','deptSel','mandalSel','panchSel','purposeSel','followSel','attachSel']) el(id).value=''; }

function enrich(rows){
  return rows.map(r=>{
    const start = parseDateLike(r['Tour Start Date & Time'] || r['Tour Start Date & Time '] || r['Start'] || r['Timestamp'] || r['Date']);
    const end = parseDateLike(r['Tour End Date & Time'] || r['Tour End Date & Time '] || r['End']);
    const dur = hoursBetween(start,end);
    const mandal = sanitize(r['Mandal Name'] || r['Mandal'] || r['MANDAL'] || r['mandal']);
    const panch = sanitize(r['Panchayat Name'] || r['Panchayat'] || r['Panchayat Name ']);
    return {...r, _start:start, _end:end, _dur: Number.isFinite(dur) && dur>=0? +dur.toFixed(2): null, _dateKey: toDateKey(start),
            _follow: classifyFollowUp(r['Follow-up Actions Required']|| r['Follow-up'] || r['Follow up']),
            _attach: hasAttachment(r['Attachments'] || r['Attachment'] || r['Attachment URL'])? 'yes' : 'no',
            _officer: sanitize(r['Name of the Officer'] || r['Officer'] || r['Name']),
            _dept: sanitize(r['Department'] || r['Dept']),
            _mandal: mandal, _panch: panch, _purpose: sanitize(r['Purpose of Visit'] || r['Purpose'] || r['Remarks']) };
  });
}

function classifyFollowUp(text){ const s=sanitize(text).toLowerCase(); if(!s) return 'Not Specified'; if(/completed|done|closed|resolved/.test(s)) return 'Completed'; if(/inform|required|pending|follow|replace|repair|forward|escalat/.test(s)) return 'Action Required/Pending'; return 'Other'; }

function populateFilters(rows){
  function fill(id, vals){
    const sel=el(id); sel.innerHTML = '<option value=\"\">All</option>'; for(const v of uniqueSorted(vals)){ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }
  }
  fill('officerSel', rows.map(r=>r._officer));
  fill('deptSel', rows.map(r=>r._dept));
  fill('mandalSel', rows.map(r=>r._mandal));
  fill('panchSel', rows.map(r=>r._panch));
  fill('purposeSel', rows.map(r=>r._purpose));
}

function applyFilters(){
  const dFrom = el('dateFrom').value? new Date(el('dateFrom').value+'T00:00:00'): null;
  const dTo = el('dateTo').value? new Date(el('dateTo').value+'T23:59:59'): null;
  const off = el('officerSel').value; const dep = el('deptSel').value; const man = el('mandalSel').value; const pan = el('panchSel').value; const pur = el('purposeSel').value; const fol = el('followSel').value; const att = el('attachSel').value;
  return RAW.filter(r=>{ if(dFrom && (!r._start || r._start < dFrom)) return false; if(dTo && (!r._start || r._start > dTo)) return false; if(off && r._officer !== off) return false; if(dep && r._dept !== dep) return false; if(man && r._mandal !== man) return false; if(pan && r._panch !== pan) return false; if(pur && r._purpose !== pur) return false; if(fol && r._follow !== fol) return false; if(att && r._attach !== att) return false; return true; });
}

function renderAll(records){
  const total = records.length; const officers = new Set(records.map(r=>r._officer)).size; const avgDur = mean(records.map(r=>r._dur)); const attachCount = records.filter(r=>r._attach==='yes').length;
  el('kTotal').textContent = total; el('kOff').textContent = officers; el('kDur').textContent = avgDur? avgDur.toFixed(2): '-'; el('kAttach').textContent = `${attachCount} (${total? Math.round(attachCount*100/total):0}%)`;

  let m = groupCount(records, r=>r._officer); let arr = topN(m, 30);
  Plotly.newPlot('chartOfficer',[{type:'bar', x:arr.map(a=>a[0]), y:arr.map(a=>a[1]), marker:{color:arr.map((_,i)=> 'rgba(14,165,233,'+ (0.6 + (i%6)*0.05) +')') }}], {margin:{t:20,b:120}});

  m = groupCount(records, r=>r._dept); arr = Array.from(m.entries());
  Plotly.newPlot('chartDept',[{type:'pie', labels:arr.map(a=>a[0]), values:arr.map(a=>a[1]), hole:.35}], {margin:{t:20}});

  m = groupCount(records, r=>r._mandal); arr = topN(m, 20);
  Plotly.newPlot('chartMandal',[{type:'bar', x:arr.map(a=>a[0]), y:arr.map(a=>a[1])}], {margin:{t:20,b:120}});

  m = groupCount(records, r=>r._purpose); arr = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
  if(arr.length <= 10){ Plotly.newPlot('chartPurpose',[{type:'pie', labels:arr.map(a=>a[0]), values:arr.map(a=>a[1])}], {margin:{t:20}}); } else { Plotly.newPlot('chartPurpose',[{type:'bar', x:arr.map(a=>a[0]), y:arr.map(a=>a[1])}], {margin:{t:20,b:120}}); }

  m = groupCount(records, r=>r._follow); arr = Array.from(m.entries());
  Plotly.newPlot('chartFollow',[{type:'pie', labels:arr.map(a=>a[0]), values:arr.map(a=>a[1])}], {margin:{t:20}});

  const durs = records.map(r=>r._dur).filter(x=>Number.isFinite(x));
  Plotly.newPlot('chartDur',[{type:'histogram', x:durs, nbinsx:20}], {margin:{t:20}});

  const counts = groupCount(records.filter(r=>r._dateKey!=='Invalid'), r=>r._dateKey);
  const arrt = Array.from(counts.entries()).sort((a,b)=> a[0] < b[0] ? -1:1);
  Plotly.newPlot('chartTime',[{type:'scatter', mode:'lines+markers', x:arrt.map(a=>a[0]), y:arrt.map(a=>a[1])}], {margin:{t:20}});

  const tbody = document.querySelector('#recentTable tbody'); tbody.innerHTML = '';
  const sorted = [...records].sort((a,b)=> (b._start||0) - (a._start||0)).slice(0,50);
  for(const r of sorted){ const tr=document.createElement('tr'); const cells=[ r._start && !isNaN(r._start)? r._start.toLocaleString() : '-', r._officer, r._dept, r._mandal, r._panch, r._purpose, Number.isFinite(r._dur)? r._dur.toFixed(2): '-' ]; for(const c of cells){ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td);} tbody.appendChild(tr); }

  const ins = el('insights'); ins.innerHTML=''; const topMandals = topN(groupCount(records, r=> r._mandal),5); const pending = records.filter(r=> r._follow === 'Action Required/Pending').length; const div1 = document.createElement('div'); div1.textContent = `Top Mandals: ${topMandals.map(a=>a[0]).slice(0,5).join(', ')}`; ins.appendChild(div1); const div2=document.createElement('div'); div2.textContent=`Pending follow-ups: ${pending}`; ins.appendChild(div2);
}

function ensureMap(){ if(!MAP){ MAP = L.map('map').setView([18.05,78.27], 8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'© OpenStreetMap'}).addTo(MAP); } if(GEO_LAYER){ GEO_LAYER.remove(); GEO_LAYER=null; } }
function renderMap(records){ ensureMap(); if(!GEO) return; if(GEO_LAYER) GEO_LAYER.remove(); const counts={}; for(const r of records){ const k=(r._mandal||'').toLowerCase().trim(); if(k) counts[k]=(counts[k]||0)+1; } const vals=Object.values(counts); const max=vals.length? Math.max(...vals):1; function colorFor(v){ const t=v/max; const r=Math.round(240-160*t); const g=Math.round(250-120*t); const b=255; return `rgb(${r},${g},${b})`; } GEO_LAYER = L.geoJSON(GEO,{ style: f=>{ const props=f.properties||{}; const name=(props.Mandal||props.mandal||props.NAME_3||props.NAME||props.name||'').toString().trim(); const v=counts[name.toLowerCase()]||0; return {color:'#083047', weight:1, fillColor: colorFor(v), fillOpacity:0.8}; }, onEachFeature: (feature, layer)=>{ const props=feature.properties||{}; const name=(props.Mandal||props.mandal||props.NAME_3||props.NAME||props.name||'').toString().trim(); const v=counts[name.toLowerCase()]||0; layer.bindTooltip(`<b>${name}</b><br/>Tours: ${v}`); layer.on('click', ()=>{ showFeatureDetails(name, records.filter(r=> (r._mandal||'').toLowerCase() === name.toLowerCase())); }); } }).addTo(MAP); try{ MAP.fitBounds(GEO_LAYER.getBounds(), {padding:[20,20]}); }catch(e){} }
function showFeatureDetails(name, recs){ let html = `${name}\\n\\nRecent tours (${recs.length}):\\n`; recs.slice(0,10).forEach(r=>{ html+=`\\n${r._start? r._start.toLocaleString() : '-'} — ${r._officer} — ${r._purpose}`; }); alert(html); }

function exportCSV(records){ const rows=[['Timestamp','Officer','Department','Mandal','Panchayat','Purpose','Start','End','Duration','FollowUp','Attachments']]; for(const r of records){ rows.push([ sanitize(r['Timestamp']||r['Timestamp ']||''), r._officer, r._dept, r._mandal, r._panch, r._purpose, r._start? r._start.toISOString():'', r._end? r._end.toISOString():'', r._dur||'', r._follow, r._attach ]); } const csv = rows.map(r=> r.map(c=>'\"'+String(c||'').replace(/\"/g,'\"\"')+'\"').join(',')).join('\\n'); downloadFile('medak_filtered_export.csv', csv); }

async function loadAll(){
  const sid = el('sheetId').value || localStorage.getItem('medak_sheetId'); const key = el('apiKey').value || localStorage.getItem('medak_apiKey'); const range = el('sheetRange').value || localStorage.getItem('medak_sheetRange') || 'Form Responses 1!A:Z'; const geoUrl = el('geoUrl').value || localStorage.getItem('medak_geoUrl') || '';
  if(!sid || !key){ alert('Please enter Sheet ID and API Key'); return; }
  try{ const rows = await fetchSheet(sid, key, range); RAW = enrich(rows); populateFilters(RAW); if(geoUrl){ GEO = await fetchGeoJSON(geoUrl); } else { GEO = null; } renderAll(RAW); if(GEO) renderMap(RAW); saveCfg({sheetId:sid, apiKey:key, sheetRange:range, geoUrl:geoUrl}); }catch(e){ console.error(e); alert('Load failed: '+ e.message); }
}

setInterval(async ()=>{ try{ const sid=el('sheetId').value || localStorage.getItem('medak_sheetId'); const key=el('apiKey').value || localStorage.getItem('medak_apiKey'); const range=el('sheetRange').value || 'Form Responses 1!A:Z'; if(sid && key){ const rows = await fetchSheet(sid,key,range); RAW = enrich(rows); populateFilters(RAW); const f = applyFilters(); renderAll(f); if(GEO) renderMap(f);} }catch(e){ console.warn('Auto-refresh error', e); } }, 180000);

(function(){ const c = loadCfg(); if(c.sheetId) el('sheetId').value = c.sheetId; if(c.apiKey) el('apiKey').value = c.apiKey; if(c.sheetRange) el('sheetRange').value = c.sheetRange; if(c.geoUrl) el('geoUrl').value = c.geoUrl; if(c.sheetId && c.apiKey){ loadAll().catch(()=>{}); } })();
</script>
</body>
</html>
